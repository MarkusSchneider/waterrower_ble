<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaterRower Training</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.png">
    <link rel="stylesheet" href="/styles.css">
</head>

<body>
    <!-- Server Disconnect Overlay -->
    <div class="disconnect-overlay" id="disconnectOverlay">
        <div class="disconnect-message">
            <div class="disconnect-icon">‚ö†Ô∏è</div>
            <h2>Server Disconnected</h2>
            <p>The connection to the WaterRower server has been lost. The server may have been shut down or your network
                connection was interrupted.</p>
            <button class="reconnect-button" onclick="location.reload()">Reconnect</button>
        </div>
    </div>

    <!-- Configuration Menu Overlay -->
    <div class="overlay" id="configOverlay" onclick="toggleConfigMenu()"></div>

    <!-- Configuration Menu -->
    <div class="config-menu" id="configMenu">
        <div class="config-menu-header">
            <h2>‚öôÔ∏è Configuration</h2>
            <button class="close-config" onclick="toggleConfigMenu()">√ó</button>
        </div>
        <div class="config-menu-content">
            <!-- WaterRower Connection Card -->
            <div class="card" id="wrCard">
                <h2>üö£ WaterRower Connection</h2>
                <div style="margin-bottom: 10px;">
                    Status: <span id="wrStatus" class="state-indicator state-idle">Disconnected</span>
                </div>
                <div class="controls" style="margin-bottom: 10px;">
                    <button id="btnConnectWR" class="btn-start" onclick="connectWR()">Connect</button>
                </div>
                <div id="wrAlert" class="hidden"></div>
            </div>

            <!-- Heart Rate Monitor Card -->
            <div class="card" id="hrmCard">
                <h2>‚ù§Ô∏è Heart Rate Monitor</h2>
                <div style="margin-bottom: 10px;">
                    Status: <span id="hrmStatus" class="state-indicator state-idle">Disconnected</span>
                </div>
                <div class="controls" style="margin-bottom: 10px;">
                    <button id="btnDiscoverHRM" class="btn-secondary" onclick="discoverHRM()">Discover</button>
                    <select id="hrmDeviceSelect"
                        style="min-width:150px;display:none;padding:8px;border:2px solid #e5e7eb;border-radius:6px;flex:1;"
                        onchange="selectHRMDevice()"></select>
                    <button id="btnConnectHRM" class="btn-start" onclick="connectHRM()">Connect</button>
                    <button id="btnDisconnectHRM" class="btn-secondary hidden"
                        onclick="disconnectHRM()">Disconnect</button>
                </div>
                <div id="hrmAlert" class="hidden"></div>
            </div>

            <!-- Garmin Configuration -->
            <div class="card garmin-config">
                <h2>‚öôÔ∏è Garmin Connect</h2>
                <div id="garminAlert" class="hidden"></div>
                <div class="input-group">
                    <label for="garminEmail">Email:</label>
                    <input type="email" id="garminEmail" placeholder="your@email.com">
                </div>
                <div class="input-group">
                    <label for="garminPassword">Password:</label>
                    <input type="password" id="garminPassword" placeholder="Your Garmin password">
                </div>
                <button class="btn-secondary" onclick="configureGarmin()" style="width: 100%;">Save & Test
                    Connection</button>
                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    Status: <span id="garminStatus">Not configured</span>
                </p>
            </div>

            <!-- Session Mode Configuration -->
            <div class="card">
                <h2>üéØ Session Mode</h2>
                <div id="sessionModeAlert" class="hidden"></div>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                    Choose how your training session will operate:
                </p>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; cursor: pointer;">
                        <input type="radio" name="sessionMode" value="training" onchange="updateSessionMode()"
                            style="margin-right: 8px;">
                        <strong>Training</strong> - Standard rowing session with WaterRower
                    </label>
                    <label style="display: block; margin-bottom: 8px; cursor: pointer;">
                        <input type="radio" name="sessionMode" value="record" onchange="updateSessionMode()"
                            style="margin-right: 8px;">
                        <strong>Record</strong> - Record WaterRower data for later replay
                    </label>
                    <label style="display: block; margin-bottom: 8px; cursor: pointer;">
                        <input type="radio" name="sessionMode" value="replay" onchange="updateSessionMode()"
                            style="margin-right: 8px;">
                        <strong>Replay</strong> - Simulate a session from recorded data
                    </label>
                </div>
                <div id="replayFileSelection" class="hidden" style="margin-top: 15px;">
                    <label for="recordingFileSelect"
                        style="display: block; margin-bottom: 5px; font-weight: bold;">Select Recording:</label>
                    <select id="recordingFileSelect" onchange="updateRecordingFile()"
                        style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; margin-bottom: 10px;">
                        <option value="">-- Choose a recording --</option>
                    </select>
                    <button class="btn-secondary" onclick="refreshRecordings()" style="width: 100%;">
                        üîÑ Refresh Recordings
                    </button>
                </div>
            </div>

            <!-- FIT Files Download -->
            <div class="card">
                <h2>üìÅ Saved FIT Files</h2>
                <div id="fitFilesAlert" class="hidden"></div>
                <div id="fitFilesList" style="max-height: 300px; overflow-y: auto;">
                    <p style="text-align: center; color: #666;">Loading...</p>
                </div>
                <button class="btn-secondary" onclick="refreshFitFiles()" style="width: 100%; margin-top: 10px;">
                    üîÑ Refresh List
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <button class="config-toggle" onclick="toggleConfigMenu()">‚ò∞</button>
            <div class="header-content">
                <h1>üö£ WaterRower Training</h1>
                <p>Track your rowing sessions with HR & Garmin Connect</p>
            </div>
            <div style="width: 45px;"></div>
        </header>

        <!-- Status Card -->
        <div class="card">
            <h2>Current Session</h2>
            <div class="status-line">
                <div>
                    Status: <span id="sessionState" class="state-indicator state-idle">IDLE</span>
                </div>
                <div class="device-status" id="wrStatusMain">
                    <span class="device-status-icon">üö£</span>
                    <span id="wrStatusText" class="state-indicator state-disconnected">Disconnected</span>
                </div>
                <div class="device-status" id="hrmStatusMain">
                    <span class="device-status-icon">‚ù§Ô∏è</span>
                    <span id="hrmStatusText" class="state-indicator state-disconnected">Disconnected</span>
                    <span id="hrmBattery" style="color: #666;"></span>
                </div>
            </div>

            <div class="status-display">
                <div class="metric">
                    <div class="metric-label">Time</div>
                    <div class="metric-value">
                        <span id="timeValue">0:00</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Distance</div>
                    <div class="metric-value">
                        <span id="distanceValue">0</span>
                        <span class="metric-unit">m</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Stroke Rate</div>
                    <div class="metric-value">
                        <span id="strokeRateValue">0</span>
                        <span class="metric-unit">SPM</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Speed</div>
                    <div class="metric-value">
                        <span id="speedValue">0.0</span>
                        <span class="metric-unit">km/h</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Power</div>
                    <div class="metric-value">
                        <span id="powerValue">0</span>
                        <span class="metric-unit">W</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Heart Rate</div>
                    <div class="metric-value">
                        <span id="heartRateValue">--</span>
                        <span class="metric-unit">BPM</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Calories</div>
                    <div class="metric-value">
                        <span id="caloriesValue">0</span>
                        <span class="metric-unit">kcal</span>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button id="btnStart" class="btn-start" onclick="startSession()">Start</button>
                <button id="btnPause" class="btn-pause" onclick="pauseSession()" disabled>Pause</button>
                <button id="btnResume" class="btn-pause hidden" onclick="resumeSession()">Resume</button>
                <button id="btnStop" class="btn-stop" onclick="stopSession()" disabled>Stop & Save</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="/app.js"></script>
</body>

</html>